<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="fc-id" content="REPLACE_WITH_FUNDING_CHOICES_ID" />
    <title>Images to PDF - EditMyPDFs.com</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #fff;
        color: #111;
        margin: 0;
        padding: 0;
      }
      /* Header replaced by shared component */
      main { max-width: 900px; margin: 3rem auto; padding: 1rem; text-align: center; }
      h2 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }
      p.sub {
        color: #555;
        margin-bottom: 2rem;
      }
      .card { border: 1px solid #eee; border-radius: 16px; padding: 2rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
      /* Footer replaced by shared component */
      input {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.6rem 0.9rem;
      }
      button:hover {
        opacity: 0.9;
      }
      .upload-box {
        border: 2px dashed #ccc;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 1.5rem;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .upload-box:hover {
        background: #f8faff;
      }
      .upload-box.dragover {
        border-color: #2563eb;
        background: #f8faff;
      }
  .file-info { margin-top: 1rem; color: #333; font-weight: 500; font-size: 0.95rem; }
      .thumbs { display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; margin-top: 1rem; }
      .thumb { position:relative; border:1px solid #eee; border-radius: 10px; overflow: hidden; background:#fafafa; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
      .thumb img { width: 100%; height: 120px; object-fit: cover; display: block; }
      .thumb .name { position:absolute; left:6px; right:6px; bottom:6px; background: rgba(255,255,255,0.85); border-radius:6px; padding:2px 6px; font-size:.72rem; color:#333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .field { max-width: 420px; margin: 1rem auto 0; text-align: left; }
  .field label { display: block; margin: .25rem 0 .35rem; color: #444; font-weight: 600; }
  .field input[type="text"] { width: 100%; }
      .progress {
        margin-top: 1rem;
        color: #555;
      }
      .ad-box {
        margin-top: 3rem;
        height: 90px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #999;
        font-weight: 500;
      }
      footer {
        text-align: center;
        padding: 2rem;
        color: #777;
        font-size: 0.9rem;
        border-top: 1px solid #eee;
        margin-top: 3rem;
      }
    </style>
  </head>
  <body>
    <header data-include="navbar"></header>
    <main class="feature">
      <h2>Images to PDF</h2>
      <p class="sub">Upload multiple images and click ‚ÄúCreate PDF‚Äù.</p>

      <div class="card">
        <label class="upload-box" id="drop-zone">
          üñºÔ∏è Drop your images here or click to upload
          <input
            type="file"
            id="file-input"
            accept="image/*"
            multiple
            style="display: none"
          />
        </label>

        <!-- File info text -->
        <div id="file-info" class="file-info"></div>

        <!-- Thumbnails grid -->
        <div id="thumbs" class="thumbs" aria-live="polite"></div>

        <div class="field">
          <label for="output-name">Output filename</label>
          <input
            type="text"
            id="output-name"
            placeholder="e.g., images-to-pdf"
            value="images-to-pdf"
          />
        </div>

        <div class="controls inline-actions" style="margin-top: .75rem">
          <button id="start-btn" class="primary" disabled>Create PDF</button>
          <button id="download-btn" class="primary" style="display: none">Download PDF</button>
        </div>
        <div class="progress" id="status"></div>
      </div>

  <div class="ad-box" data-ad-slot="images-to-pdf-bottom">Ad Space</div>
    </main>

  <div data-include="footer"></div>

    <script>
      const { jsPDF } = window.jspdf;
      const fileInput = document.getElementById("file-input");
      const dropZone = document.getElementById("drop-zone");
      const startBtn = document.getElementById("start-btn");
      const statusText = document.getElementById("status");
      const downloadBtn = document.getElementById("download-btn");
      const fileInfo = document.getElementById("file-info");
  const thumbs = document.getElementById("thumbs");

      let imageFiles = [];
      let pdfBlob = null;
  const thumbURLs = new Map(); // key -> objectURL

      // Clicking the label will naturally trigger the hidden file input
      // (input is nested inside the label). Avoid manual .click() to
      // prevent duplicate dialogs.

      // Drag & drop
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("dragover")
      );
      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        const files = Array.from(e.dataTransfer.files).filter((f) =>
          f.type.startsWith("image/")
        );
        if (files.length) await loadFiles(files);
      });

      // Normal select
      fileInput.addEventListener("click", (e) => e.stopPropagation());
      fileInput.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length) await loadFiles(files, /* append */ true);
        // allow re-selecting same files by resetting value
        e.target.value = "";
      });

      function uniqueByKey(list) {
        const map = new Map();
        for (const f of list) {
          const key = `${f.name}|${f.size}|${f.lastModified}`;
          if (!map.has(key)) map.set(key, f);
        }
        return Array.from(map.values());
      }

      async function loadFiles(files, append = false) {
        const incoming = Array.from(files).filter((f) =>
          f.type.startsWith("image/")
        );
        imageFiles = append
          ? uniqueByKey([...imageFiles, ...incoming])
          : uniqueByKey(incoming);

        const totalSize = imageFiles.reduce((acc, f) => acc + (f.size || 0), 0);
        const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
        const names = imageFiles.map((f) => f.name).join(", ");
        fileInfo.textContent = `üñºÔ∏è ${imageFiles.length} image(s) selected (${sizeMB} MB): ${names}`;
        startBtn.disabled = imageFiles.length === 0;
        statusText.textContent = "";
        downloadBtn.style.display = "none";

        renderThumbs();
      }

      function fileKey(f){ return `${f.name}|${f.size}|${f.lastModified}`; }

      function renderThumbs(){
        if (!thumbs) return;
        // Revoke URLs for files no longer present
        const keys = new Set(imageFiles.map(fileKey));
        for (const [k, url] of Array.from(thumbURLs.entries())){
          if (!keys.has(k)) { URL.revokeObjectURL(url); thumbURLs.delete(k); }
        }
        // Build grid
        thumbs.innerHTML = '';
        imageFiles.forEach((f) => {
          const key = fileKey(f);
          let url = thumbURLs.get(key);
          if (!url){ url = URL.createObjectURL(f); thumbURLs.set(key, url); }
          const item = document.createElement('div');
          item.className = 'thumb';
          const img = document.createElement('img');
          img.src = url; img.alt = f.name;
          const name = document.createElement('div');
          name.className = 'name'; name.textContent = f.name;
          item.appendChild(img); item.appendChild(name);
          thumbs.appendChild(item);
        });
      }

      startBtn.addEventListener("click", async () => {
        if (!imageFiles.length) return;
        startBtn.disabled = true;
        statusText.textContent = "Creating PDF...";
        try {
          await imagesToPDF(imageFiles);
        } catch (err) {
          console.error(err);
          statusText.textContent = "Failed to create PDF.";
          startBtn.disabled = false;
        }
      });

      async function loadImage(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = reader.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      async function imagesToPDF(files) {
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          statusText.textContent = `Adding image ${i + 1}/${files.length}...`;
          const img = await loadImage(f);

          const imgRatio = img.width / img.height;
          const pageRatio = pageWidth / pageHeight;

          let renderWidth, renderHeight;
          if (imgRatio > pageRatio) {
            // Fit to width
            renderWidth = pageWidth;
            renderHeight = pageWidth / imgRatio;
          } else {
            // Fit to height
            renderHeight = pageHeight;
            renderWidth = pageHeight * imgRatio;
          }

          const x = (pageWidth - renderWidth) / 2;
          const y = (pageHeight - renderHeight) / 2;

          if (i > 0) pdf.addPage();
          const format = /png/i.test(f.type) ? "PNG" : "JPEG";
          pdf.addImage(img, format, x, y, renderWidth, renderHeight);
        }

        pdfBlob = pdf.output("blob");
        downloadBtn.style.display = "inline-block";
        statusText.textContent = "PDF created successfully!";
        startBtn.disabled = false;
      }

      function getOutputName(defaultBase) {
        const el = document.getElementById("output-name");
        let name =
          (el && el.value ? el.value : "").trim() || defaultBase || "output";
        name = name.replace(/[\\/:*?"<>|]/g, "-");
        if (!/\.pdf$/i.test(name)) name += ".pdf";
        return name;
      }

      downloadBtn.addEventListener("click", () => {
        if (pdfBlob) {
          const url = URL.createObjectURL(pdfBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = getOutputName("images-to-pdf");
          a.click();
          URL.revokeObjectURL(url);
        }
      });

      // Cleanup object URLs on page unload
      window.addEventListener('beforeunload', () => {
        for (const url of thumbURLs.values()) URL.revokeObjectURL(url);
        thumbURLs.clear();
      });
    </script>
    <script src="../assets/app.js"></script>
  </body>
</html>
