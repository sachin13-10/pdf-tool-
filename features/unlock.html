<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="fc-id" content="REPLACE_WITH_FUNDING_CHOICES_ID" />
    <title>Unlock PDF - EditMyPDFs.com</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../assets/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
      /* Minimal, aligned layout mirroring Password Protect */
      .unlock-card { max-width: 760px; margin: 0 auto; padding: 2.5rem; }
      .unlock-card .upload-box { margin-top: .6rem; margin-bottom: 1.4rem; min-height:160px; display:flex; align-items:center; justify-content:center; font-size:1.05rem; }
      .field { max-width: 520px; margin: 1.1rem auto 0; text-align: left; }
      .field label { display:block; margin:.25rem 0 .45rem; color:#444; font-weight:600; }
      .field input { width:100%; }
      .actions { display:flex; justify-content:center; gap:.9rem; flex-wrap:wrap; margin-top:1.25rem; }
      .file-info { margin-top: .5rem; color:#333; font-weight:500; font-size:.95rem; min-height:1.1rem; }
    </style>
  </head>
  <body>
    <header data-include="navbar"></header>

  <main class="feature">
      <h2>Unlock PDF</h2>
      <p class="sub">
        Remove password protection (processing happens entirely in your
        browser). Only unlock PDFs you own or have explicit permission to
        modify.
      </p>

      <div class="card feature-enter unlock-card">
        <label class="upload-box" id="drop-zone">
          ðŸ“„ Drop your PDF here or click to upload
          <input
            type="file"
            id="file-input"
            accept="application/pdf"
            style="display: none"
          />
        </label>

        <div id="file-info" class="file-info"></div>

        <div class="field">
          <label for="password">Password (if required)</label>
          <input
            type="password"
            id="password"
            placeholder="Enter password if prompted"
          />
        </div>

        <div class="field">
          <label for="output-name">Output filename</label>
          <input
            type="text"
            id="output-name"
            placeholder="e.g., unlocked"
            value="unlocked"
          />
        </div>

        <div class="actions">
          <button id="unlock-btn" class="primary" disabled>Unlock PDF</button>
        </div>
        <div id="status" class="progress"></div>
        <div class="actions">
          <button id="download-btn" class="primary" style="display: none">
            Download Unlocked PDF
          </button>
        </div>
      </div>

      <div class="ad-box" data-ad-slot="unlock-bottom">Ad Space</div>
    </main>

    <div data-include="footer"></div>

    <script>
      const pdfjsLib = window["pdfjs-dist/build/pdf"];
      if (pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
      }

      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("file-input");
      const fileInfo = document.getElementById("file-info");
      const unlockBtn = document.getElementById("unlock-btn");
      const statusText = document.getElementById("status");
      const downloadBtn = document.getElementById("download-btn");
      const passwordInput = document.getElementById("password");

      let srcBytes = null;
      let outBlob = null;

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("dragover")
      );
      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        const f = e.dataTransfer.files[0];
        if (f) await loadFile(f);
      });
      fileInput.addEventListener("click", (e) => e.stopPropagation());
      fileInput.addEventListener("change", async (e) => {
        const f = e.target.files[0];
        if (f) await loadFile(f);
        e.target.value = "";
      });

      async function loadFile(f) {
        const sizeMB = (f.size / (1024 * 1024)).toFixed(2);
        fileInfo.textContent = `ðŸ“„ ${f.name} (${sizeMB} MB uploaded)`;
        const buf = await f.arrayBuffer();
        srcBytes = new Uint8Array(buf);
        unlockBtn.disabled = false;
        statusText.textContent = "";
        downloadBtn.style.display = "none";
      }

      function getOutputName(defaultBase) {
        const el = document.getElementById("output-name");
        let name =
          (el && el.value ? el.value : "").trim() || defaultBase || "output";
        name = name.replace(/[\\/:*?"<>|]/g, "-");
        if (!/\.pdf$/i.test(name)) name += ".pdf";
        return name;
      }

      async function renderToImagesWithPassword(bytes, password) {
        // Attempt to open with provided password. If wrong/missing, will throw PasswordException.
        const task = pdfjsLib.getDocument({ data: bytes, password: password || undefined });
        const pdf = await task.promise; // will reject on incorrect password
        const pages = [];
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 2.0 });
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);
          await page.render({ canvasContext: ctx, viewport }).promise;
          pages.push({ canvas, width: canvas.width, height: canvas.height });
        }
        return pages;
      }

      async function buildPDFViaPdfLib(pages) {
        const out = await PDFLib.PDFDocument.create();
        for (let i = 0; i < pages.length; i++) {
          const pg = pages[i];
          const imgBytes = await new Promise((res) =>
            pg.canvas.toBlob(
              (b) => {
                const r = new FileReader();
                r.onload = () => res(new Uint8Array(r.result));
                r.readAsArrayBuffer(b);
              },
              "image/jpeg",
              0.92
            )
          );
          const img = await out.embedJpg(imgBytes);
          const page = out.addPage([img.width, img.height]);
          page.drawImage(img, {
            x: 0,
            y: 0,
            width: img.width,
            height: img.height,
          });
        }
        const bytes = await out.save();
        return new Blob([bytes], { type: "application/pdf" });
      }

      // Fast path: if the PDF is not encrypted, simply copy pages using pdf-lib to preserve vector quality
      async function tryFastCopyViaPdfLib(bytes) {
        try {
          const srcDoc = await PDFLib.PDFDocument.load(bytes);
          const out = await PDFLib.PDFDocument.create();
          const pages = await out.copyPages(srcDoc, srcDoc.getPageIndices());
          pages.forEach((p) => out.addPage(p));
          const outBytes = await out.save();
          return new Blob([outBytes], { type: "application/pdf" });
        } catch (e) {
          // Likely encrypted or unsupported by pdf-lib; return null to trigger rasterization fallback
          return null;
        }
      }

      unlockBtn.addEventListener("click", async () => {
        if (!srcBytes) {
          statusText.textContent = "Please upload a PDF first.";
          return;
        }
        unlockBtn.disabled = true;
        statusText.textContent = "Checking encryption and unlocking...";
        try {
          // 1) Try fast vector-preserving copy for non-encrypted PDFs
          outBlob = await tryFastCopyViaPdfLib(srcBytes);
          if (outBlob) {
            statusText.textContent =
              "Unlocked (no encryption detected). Ready to download.";
            downloadBtn.style.display = "inline-block";
            return;
          }

          // 2) Fallback: open with password via pdf.js, rasterize pages, rebuild unencrypted PDF
          statusText.textContent =
            "Encrypted PDF detected. Rendering pages (this may take a moment)...";
          const enteredPassword = passwordInput.value || undefined;
          const pages = await renderToImagesWithPassword(srcBytes, enteredPassword);
          statusText.textContent = "Rebuilding unlocked PDF...";
          outBlob = await buildPDFViaPdfLib(pages);
          downloadBtn.style.display = "inline-block";
          statusText.textContent = "Unlocked PDF is ready.";
        } catch (e) {
          console.error(e);
          // Distinguish wrong password vs other errors
          if (e && e.name === 'PasswordException') {
            if (/incorrect/i.test(e.message)) {
              statusText.textContent = "Incorrect password. Please try again.";
            } else if (/password/i.test(e.message)) {
              statusText.textContent = "Password required. Enter it above and press Unlock.";
            } else {
              statusText.textContent = "Could not unlock: password error.";
            }
          } else {
            statusText.textContent = "Failed to unlock PDF (unsupported encryption or corrupt file).";
          }
        } finally {
          unlockBtn.disabled = false;
        }
      });

      downloadBtn.addEventListener("click", () => {
        if (!outBlob) return;
        const url = URL.createObjectURL(outBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = getOutputName("unlocked");
        a.click();
        URL.revokeObjectURL(url);
      });
    </script>
    <script src="../assets/app.js"></script>
  </body>
</html>
