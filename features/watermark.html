<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Add watermark to PDF: apply custom text watermarks to each page. Free tool  customize opacity, size, position, no uploads."
    />
    <title>Watermark PDF - EDITSMYPDF</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/styles.css" />
    <link
      rel="canonical"
      href="https://editmypdf.tech/features/watermark.html"
    />
    `n
    <link rel="icon" type="image/png" href="../assets/images/sflogoPNG.PNG" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Inter, sans-serif;
        margin: 0;
        background: #fff;
        color: #111;
      }
      main {
        max-width: 760px;
        margin: 3rem auto;
        padding: 1rem;
        text-align: center;
      }
      h2 {
        font-size: 2rem;
        margin: 0.5rem 0 1rem;
      }
      p.sub {
        color: #555;
      }
      .card {
        border: 1px solid #eee;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        text-align: left;
      }
      .upload-box {
        border: 2px dashed #ccc;
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: 0.25s;
        text-align: center;
      }
      .upload-box:hover {
        background: #f8faff;
      }
      .upload-box.dragover {
        border-color: #e53935;
      }
      label,
      input,
      button {
        display: block;
        margin: 0.75rem auto;
        font-size: 1rem;
      }
      input[type="text"] {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.6rem 0.9rem;
        width: 260px;
      }
      button {
        background: linear-gradient(90deg, #e53935, #c62828);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.85rem 1.6rem;
        font-weight: 600;
        cursor: pointer;
      }
      button:hover {
        opacity: 0.9;
      }
      .file-info {
        margin-top: 0.5rem;
        color: #333;
        font-weight: 500;
        font-size: 0.95rem;
      }
      .progress {
        margin-top: 1rem;
        min-height: 1.3rem;
        color: #555;
        text-align: center;
      }
      .ad-box {
        margin-top: 3rem;
        height: 90px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-weight: 500;
      }

      /* Enhanced Feature Blog Styles */
      .feature-blog {
        max-width: 700px;
        margin: 3rem auto 0;
        padding: 2rem;
        background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
        border-left: 5px solid #2563eb;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(37, 99, 235, 0.08);
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.7;
        color: #475569;
      }
      .feature-blog h3 {
        font-size: 1.85rem;
        font-weight: 700;
        color: #1e40af;
        margin: 0 0 1rem;
        line-height: 1.3;
      }
      .feature-blog h4 {
        font-size: 1.35rem;
        font-weight: 600;
        color: #1e40af;
        margin: 2rem 0 0.75rem;
        line-height: 1.4;
      }
      .feature-blog p {
        margin: 0 0 1.25rem;
        font-size: 1.05rem;
      }
      .feature-blog strong {
        color: #334155;
        font-weight: 600;
      }
      .feature-blog ul,
      .feature-blog ol {
        margin: 0 0 1.5rem;
        padding-left: 1.5rem;
      }
      .feature-blog li {
        margin-bottom: 0.75rem;
        font-size: 1.02rem;
      }
      .feature-blog code {
        background: #e0e7ff;
        color: #4338ca;
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 0.92rem;
      }
      .feature-blog .hero-img {
        width: 100%;
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        margin: 1.5rem 0;
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.12);
        border: 1px solid #e0e7ff;
      }
      .feature-blog .tip {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        border-radius: 10px;
        padding: 1.25rem;
        margin: 1.5rem 0;
        font-size: 1rem;
      }
      .feature-blog .tip strong {
        color: #1e40af;
        display: block;
        margin-bottom: 0.5rem;
      }
      .feature-blog .note {
        background: #fefce8;
        border-left: 4px solid #eab308;
        border-radius: 10px;
        padding: 1.25rem;
        margin: 2rem 0 0;
        font-size: 1.05rem;
        color: #713f12;
      }
      .feature-blog .note a {
        color: #2563eb;
        font-weight: 600;
        text-decoration: none;
        border-bottom: 2px solid transparent;
        transition: border-color 0.2s;
      }
      .feature-blog .note a:hover {
        border-bottom-color: #2563eb;
      }
      .feature-blog details {
        background: #ffffff;
        border: 1px solid #e0e7ff;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.06);
        transition: all 0.3s ease;
      }
      .feature-blog details:hover {
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.12);
      }
      .feature-blog details[open] {
        background: #f8faff;
        border-color: #3b82f6;
      }
      .feature-blog summary {
        font-weight: 600;
        color: #1e40af;
        cursor: pointer;
        font-size: 1.08rem;
        padding: 0.5rem 0;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .feature-blog summary::-webkit-details-marker {
        display: none;
      }
      .feature-blog summary::before {
        content: "â–¶";
        color: #3b82f6;
        font-size: 0.85rem;
        transition: transform 0.3s;
        flex-shrink: 0;
      }
      .feature-blog details[open] summary::before {
        transform: rotate(90deg);
      }
      .feature-blog details p {
        margin-top: 0.75rem;
        padding-left: 1.5rem;
        color: #64748b;
        font-size: 1rem;
      }
      @media (max-width: 640px) {
        .feature-blog {
          padding: 1.5rem;
          margin: 2rem 0.5rem 0;
        }
        .feature-blog h3 {
          font-size: 1.5rem;
        }
        .feature-blog h4 {
          font-size: 1.15rem;
        }
        .feature-blog p,
        .feature-blog li {
          font-size: 0.98rem;
        }
      }
    </style>
  </head>
  <body>
    <header data-include="navbar"></header>
    <div id="ad-top" class="ad-slot"></div>
    <main class="feature">
      <h2>Watermark PDF</h2>
      <p class="sub">
        Add a translucent text watermark to every page clientâ€‘side. Your file
        never leaves your device.
      </p>
      <div class="card">
        <label class="upload-box" id="drop-zone"
          >ðŸ“„ Drop your PDF or click to upload
          <input
            type="file"
            id="file-input"
            accept="application/pdf"
            style="display: none"
          />
        </label>
        <div id="file-info" class="file-info"></div>
        <label for="wm-text">Watermark text</label>
        <input id="wm-text" type="text" value="CONFIDENTIAL" />
        <label for="wm-opacity">Opacity (0.1â€“1.0)</label>
        <input id="wm-opacity" type="text" value="0.2" />
        <label for="wm-color">Watermark color</label>
        <input id="wm-color" type="color" value="#e53935" />
        <label for="wm-placement">Placement</label>
        <select id="wm-placement">
          <option value="diagonal" selected>
            Diagonal (bottom-left â†’ top-right)
          </option>
          <option value="center">Center</option>
          <option value="top-left">Top-Left</option>
          <option value="top-center">Top-Center</option>
          <option value="top-right">Top-Right</option>
          <option value="middle-left">Middle-Left</option>
          <option value="middle-right">Middle-Right</option>
          <option value="bottom-left">Bottom-Left</option>
          <option value="bottom-center">Bottom-Center</option>
          <option value="bottom-right">Bottom-Right</option>
          <option value="custom">Custom (choose on preview)</option>
        </select>
        <label for="wm-size">Size</label>
        <select id="wm-size">
          <option value="auto" selected>Auto-fit (diagonal)</option>
          <option value="small">Small</option>
          <option value="medium">Medium</option>
          <option value="large">Large</option>
        </select>

        <!-- Simple preview canvas so users can choose custom location -->
        <div
          id="preview-wrap"
          style="display: block; margin: 1rem auto; text-align: center"
        >
          <div style="font-weight: 600; color: #444; margin-bottom: 0.35rem">
            Preview
          </div>
          <canvas
            id="wm-preview"
            width="320"
            height="452"
            style="
              border: 1px solid #ddd;
              border-radius: 8px;
              background: #fff;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            "
          ></canvas>
          <div
            id="preview-hint"
            style="
              font-size: 0.9rem;
              color: #666;
              margin-top: 0.4rem;
              display: none;
            "
          >
            Tip: Click or drag on the page to set the watermark position.
          </div>
        </div>
        <label for="output-name">Output filename</label>
        <input id="output-name" type="text" value="watermarked" />
        <button id="apply-btn" disabled>Apply Watermark</button>
        <button id="download-btn" style="display: none">Download PDF</button>
        <div id="status" class="progress"></div>
      </div>
      <div id="ad-content" class="ad-slot"></div>

      <!-- Enhanced Feature Blog Section -->
      <section class="feature-blog" aria-labelledby="watermark-guide-title">
        <div class="title-with-logo">
          <img
            src="../assets/images/sflogoPNG.PNG"
            alt="PDF Tools Logo"
            class="brand-logo"
          />
          <h3 id="watermark-guide-title">
            Watermark Your PDFs Brand Protection Made Simple
          </h3>
        </div>

        <p>
          <strong
            >Need to mark documents as confidential, add copyright protection,
            or brand your PDFs?</strong
          >
          Our Watermark tool adds customizable text overlays to every page of
          your PDF. Choose the text, color, opacity, position, and sizeall
          processed <strong>entirely in your browser</strong> with complete
          privacy.
        </p>

        <img
          src="../assets/images/watermark.JPG"
          alt="Add watermark to PDF documents"
          class="hero-img"
        />

        <h4>How It Works</h4>
        <p>
          The Watermark tool uses pdf-lib to read your PDF, then draws your
          custom text on every page at the position, size, color, and opacity
          you specify. All processing happens
          <strong>locally in your browser</strong> using JavaScript. No server
          uploads, no data collection. You preview the watermark on a canvas,
          adjust settings, and download the watermarked PDF.
        </p>

        <p>
          Think of it like stamping every page of a physical document with a
          translucent "CONFIDENTIAL" or "DRAFT" marking. The watermark appears
          on all pages but doesn't obscure the underlying content, making it
          perfect for status indicators, copyright notices, or branding.
        </p>

        <h4>Why Use This Tool</h4>
        <ul>
          <li>
            <strong>Document status</strong> - Mark files as DRAFT,
            CONFIDENTIAL, COPY, or FOR REVIEW
          </li>
          <li>
            <strong>Copyright protection</strong> - Add Company Name or author
            attribution
          </li>
          <li>
            <strong>Brand PDFs</strong> - Include company name or logo text on
            distributed documents
          </li>
          <li>
            <strong>Prevent misuse</strong> - Discourage unauthorized copying or
            distribution
          </li>
          <li>
            <strong>Professional appearance</strong> - Add subtle branding to
            proposals and reports
          </li>
        </ul>

        <h4>Complete Privacy</h4>
        <p>
          Your PDF never leaves your computer. All watermarking happens directly
          in your browser using pdf-lib. No files are uploaded to any server.
          This is essential when watermarking sensitive documents like
          contracts, financial records, legal briefs, or confidential reports.
        </p>

        <div class="tip">
          <strong> Your Privacy Matters:</strong><br />
          100% client-side processing - everything stays on your device<br />
          No server uploads - your document never goes online<br />
          No data logging - we never see your file contents or watermark text<br />
          Works offline - watermark PDFs even without internet connection
        </div>

        <h4>Customization Options</h4>
        <ul>
          <li>
            <strong>Text:</strong> Enter any text"CONFIDENTIAL", " 2025 YourCo",
            "DRAFT", etc.
          </li>
          <li>
            <strong>Opacity:</strong> Set from 0.1 (nearly invisible) to 1.0
            (fully opaque). 0.2-0.3 works well for most cases
          </li>
          <li>
            <strong>Color:</strong> Choose any color using the color pickerred
            for CONFIDENTIAL, gray for DRAFT
          </li>
          <li>
            <strong>Placement:</strong> Diagonal (default), center, corners, or
            custom position by clicking the preview
          </li>
          <li>
            <strong>Size:</strong> Auto-fit (scales to page), Small, Medium, or
            Large
          </li>
          <li>
            <strong>Preview:</strong> See exactly how the watermark looks before
            applying it
          </li>
        </ul>

        <h4>Watermark Tips</h4>
        <p>
          Adding a watermark is straightforward, but getting it to look
          professional takes a bit of finesse. Here's how to make your
          watermarks stand out without overwhelming the document:
        </p>
        <ul>
          <li>
            <strong>Start Subtle with Opacity:</strong> Use opacity 0.2-0.3 for
            professional-looking watermarks that don't interfere with
            readability. Too high (0.7+) and your watermark becomes a
            distraction; too low (under 0.15) and it's practically invisible.
            The sweet spot is translucent but clearly visible when you're
            looking for it.
          </li>
          <li>
            <strong>Diagonal is the Industry Standard:</strong> The default
            diagonal placement isn't just for looksâ€”it's harder to crop out than
            corner or center watermarks. If someone tries to remove a diagonal
            watermark by cropping, they'd lose significant content from the
            page. That's why most legal documents and official PDFs use diagonal
            orientation.
          </li>
          <li>
            <strong>ALL CAPS for Visibility:</strong> Watermarks like
            "CONFIDENTIAL" or "DRAFT" are way more visible and authoritative in
            capital letters. Lowercase text can blend in too much with the
            document content, especially at low opacities. ALL CAPS = instant
            recognition.
          </li>
          <li>
            <strong>Always Test on the Preview:</strong> Before applying the
            watermark to all pages, check the canvas preview carefully. Make
            sure the text is readable, positioned correctly, and doesn't obscure
            critical content. Zoom in if neededâ€”what looks fine at thumbnail
            size might block important text when viewed full-screen.
          </li>
          <li>
            <strong>Color Communicates Meaning:</strong> Red signals urgency or
            confidentiality (perfect for "CONFIDENTIAL" or "DO NOT DISTRIBUTE").
            Gray works great for status indicators like "DRAFT" or "COPY"â€”it's
            visible but neutral. Blue conveys official or formal status, like
            company branding or copyright notices. Choose color intentionally.
          </li>
          <li>
            <strong>Keep Watermarks Short:</strong> Stick to 1-3 words maximum.
            "CONFIDENTIAL" works perfectly. "This document contains confidential
            information and should not be shared" becomes a cluttered mess. Long
            text either gets too small to read or dominates the page. Brevity
            wins.
          </li>
        </ul>

        <h4>ðŸ’¼ Common Watermark Use Cases</h4>
        <p>
          Watermarks serve different purposes depending on what you're trying to
          achieve. Here are the most common scenarios and how to approach them:
        </p>
        <p>
          <strong>Draft Documents:</strong> Use "DRAFT" in gray at 0.25 opacity,
          diagonal placement. This clearly indicates the document isn't final
          without screaming for attention. Perfect for circulating proposals,
          reports, or contracts for internal review before finalizing.
        </p>
        <p>
          <strong>Confidential Materials:</strong> Use "CONFIDENTIAL" in red at
          0.3 opacity, diagonal. The red color immediately signals sensitive
          content, reminding anyone who opens the file to handle it carefully.
          Great for financial data, HR documents, or strategic business plans.
        </p>
        <p>
          <strong>Copyright Protection:</strong> Use "Â© 2025 Your Company Name"
          in gray or blue at 0.2 opacity. This subtle but clear attribution
          discourages unauthorized redistribution and makes it obvious who owns
          the content. Useful for white papers, guides, or any content you're
          distributing publicly.
        </p>
        <p>
          <strong>Review Copies:</strong> Use "FOR REVIEW ONLY" or "COPY" in
          gray at 0.25 opacity. This indicates the PDF is meant for feedback,
          not final distribution, and shouldn't be treated as the official
          version.
        </p>
        <p>
          <strong>Pro tip:</strong> If you're watermarking multiple documents
          for the same purpose (like marking 20 reports as confidential), note
          your preferred settings (text, color, opacity, position) so you can
          apply them consistently across all files. Consistency makes your
          documents look more professional and organized.
        </p>

        <h4>Quick Guide</h4>
        <ol>
          <li>
            <strong>Upload your PDF:</strong> Click or drag your file into the
            upload area
          </li>
          <li>
            <strong>Enter watermark text:</strong> Type your desired text (e.g.,
            "CONFIDENTIAL")
          </li>
          <li>
            <strong>Set opacity:</strong> Adjust 0.1-1.0 (0.2 recommended for
            subtle effect)
          </li>
          <li>
            <strong>Choose color:</strong> Use the color picker to select
            watermark color
          </li>
          <li>
            <strong>Select placement:</strong> Pick diagonal, center, corner, or
            custom position
          </li>
          <li>
            <strong>Preview:</strong> Check the canvas to see how it looks
          </li>
          <li>
            <strong>Apply watermark:</strong> Click the button to process all
            pages
          </li>
          <li><strong>Download:</strong> Save your watermarked PDF!</li>
        </ol>

        <h4>Frequently Asked Questions</h4>
        <details>
          <summary>Can I add different watermarks to different pages?</summary>
          <p>
            Not currentlythis tool applies the same watermark to all pages. If
            you need page-specific watermarks, you'd need to split the PDF,
            watermark each section separately, then merge them back together.
          </p>
        </details>

        <details>
          <summary>Does the watermark affect PDF quality?</summary>
          <p>
            No. The watermark is added as a text layer on top of existing
            content. The original PDF content (text, images, vectors) remains
            unchanged with no quality loss.
          </p>
        </details>

        <details>
          <summary>Can someone remove the watermark?</summary>
          <p>
            Technically, yeswatermarks are not encryption or security features.
            They're visual deterrents and indicators. For true document
            protection, use password protection or encryption instead.
          </p>
        </details>

        <details>
          <summary>Can I watermark password-protected PDFs?</summary>
          <p>
            If the PDF requires a password to open, you'll need to unlock it
            first using our Unlock tool. Once unlocked, you can add watermarks,
            then re-protect it with our Password Protect tool if needed.
          </p>
        </details>

        <details>
          <summary>What's the best opacity setting?</summary>
          <p>
            For most professional documents, 0.2-0.3 works wellvisible enough to
            read but subtle enough not to distract. For very light backgrounds
            use 0.3-0.4; for dark backgrounds try 0.5-0.6 with white or
            light-colored text.
          </p>
        </details>

        <details>
          <summary>Can I use special characters or emojis?</summary>
          <p>
            Standard text and common symbols (, , ) work reliably. Emoji support
            depends on the PDF viewer and font embedding. For maximum
            compatibility, stick to alphanumeric text and standard symbols.
          </p>
        </details>

        <div class="note">
          Ready to watermark your PDF? Upload your file, customize your
          watermark text and appearance, and download your branded document in
          seconds. <a href="#file-input">Try it now </a>
        </div>
      </section>
    </main>
    <div id="ad-footer" class="ad-slot"></div>
    <div data-include="footer"></div>

    <script>
      const fileInput = document.getElementById("file-input");
      const dropZone = document.getElementById("drop-zone");
      const applyBtn = document.getElementById("apply-btn");
      const downloadBtn = document.getElementById("download-btn");
      const statusText = document.getElementById("status");
      const fileInfo = document.getElementById("file-info");
      const wmTextInput = document.getElementById("wm-text");
      const wmOpacityInput = document.getElementById("wm-opacity");
      const wmColorInput = document.getElementById("wm-color");
      const placementSelect = document.getElementById("wm-placement");
      const sizeSelect = document.getElementById("wm-size");
      const previewCanvas = document.getElementById("wm-preview");
      const previewHint = document.getElementById("preview-hint");
      const pctx = previewCanvas.getContext("2d");
      // Normalized custom position within inner margins [0..1]
      let customPos = { x: 0.5, y: 0.5 };
      let dragging = false;
      let srcBytes = null;
      let outBlob = null;
      let loaded = null;

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("dragover")
      );
      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        const f = e.dataTransfer.files[0];
        if (f) await loadFile(f);
      });
      fileInput.addEventListener("change", async (e) => {
        const f = e.target.files[0];
        if (f) await loadFile(f);
        e.target.value = "";
      });

      async function loadFile(file) {
        statusText.textContent = "Reading PDF...";
        try {
          srcBytes = new Uint8Array(await file.arrayBuffer());
          loaded = await PDFLib.PDFDocument.load(srcBytes, {
            ignoreEncryption: true,
          });
          fileInfo.textContent = `ðŸ“„ ${file.name} (${(
            file.size /
            1024 /
            1024
          ).toFixed(2)} MB)`;
          applyBtn.disabled = false;
          statusText.textContent = "Loaded. Enter watermark.";
        } catch (e) {
          console.error(e);
          statusText.textContent = "Failed to read PDF.";
          applyBtn.disabled = true;
        }
      }

      function getOutputName(def) {
        const el = document.getElementById("output-name");
        let name = (el && el.value ? el.value : "").trim() || def || "output";
        name = name.replace(/[\\/:*?"<>|]/g, "-");
        if (!/\.pdf$/i.test(name)) name += ".pdf";
        return name;
      }

      // -------- Preview logic --------
      function drawPreview() {
        // Paper background
        pctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        pctx.fillStyle = "#fff";
        pctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
        pctx.strokeStyle = "#e5e7eb";
        pctx.strokeRect(
          0.5,
          0.5,
          previewCanvas.width - 1,
          previewCanvas.height - 1
        );

        const text = (wmTextInput.value || "").trim() || "WATERMARK";
        const hex = wmColorInput.value || "#e53935";
        // Convert hex to rgba string for canvas
        function hexToRGBA(h, a) {
          const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h || "");
          const r = m ? parseInt(m[1], 16) : 229,
            g = m ? parseInt(m[2], 16) : 57,
            b = m ? parseInt(m[3], 16) : 53;
          return `rgba(${r},${g},${b},${a})`;
        }
        const opacity = Math.min(
          1,
          Math.max(0.05, parseFloat(wmOpacityInput.value) || 0.2)
        );
        const margin =
          Math.max(previewCanvas.width, previewCanvas.height) * 0.06;

        function sizeFactor(mode) {
          return mode === "small" ? 0.08 : mode === "large" ? 0.18 : 0.12;
        }
        const placement = placementSelect.value;
        const sizeMode = sizeSelect.value;

        if (placement === "diagonal") {
          let fontSize;
          if (sizeMode === "auto") {
            const target = Math.hypot(
              previewCanvas.width - 2 * margin,
              previewCanvas.height - 2 * margin
            );
            let estimate = 24;
            pctx.font = `${estimate}px Helvetica, Arial, sans-serif`;
            const unitW = pctx.measureText(text).width / estimate;
            fontSize =
              unitW > 0
                ? target / unitW
                : Math.min(previewCanvas.width, previewCanvas.height) / 5;
          } else {
            fontSize =
              Math.min(previewCanvas.width, previewCanvas.height) *
              sizeFactor(sizeMode);
          }
          pctx.save();
          pctx.translate(margin, previewCanvas.height - margin);
          pctx.rotate(-Math.PI / 4);
          pctx.fillStyle = hexToRGBA(hex, opacity);
          pctx.font = `${fontSize}px Helvetica, Arial, sans-serif`;
          pctx.fillText(text, 0, 0);
          pctx.restore();
        } else if (placement === "custom") {
          const fontSize =
            sizeMode === "auto"
              ? Math.min(previewCanvas.width, previewCanvas.height) * 0.12
              : Math.min(previewCanvas.width, previewCanvas.height) *
                sizeFactor(sizeMode);
          const x = margin + customPos.x * (previewCanvas.width - 2 * margin);
          const y = margin + customPos.y * (previewCanvas.height - 2 * margin);
          pctx.save();
          pctx.translate(x, y);
          pctx.rotate(-Math.PI / 4);
          pctx.fillStyle = hexToRGBA(hex, opacity);
          pctx.font = `${fontSize}px Helvetica, Arial, sans-serif`;
          const m = pctx.measureText(text);
          const tw = m.width;
          const th = fontSize;
          pctx.fillText(text, -tw / 2, th / 2);
          pctx.restore();
          pctx.fillStyle = "rgba(0,0,0,.12)";
          pctx.beginPath();
          pctx.arc(x, y, 6, 0, Math.PI * 2);
          pctx.fill();
        } else {
          const fontSize =
            sizeMode === "auto"
              ? Math.min(previewCanvas.width, previewCanvas.height) * 0.12
              : Math.min(previewCanvas.width, previewCanvas.height) *
                sizeFactor(sizeMode);
          pctx.font = `${fontSize}px Helvetica, Arial, sans-serif`;
          const tw = pctx.measureText(text).width;
          const th = fontSize;
          const W = previewCanvas.width,
            H = previewCanvas.height;
          let x = margin,
            y = H - margin; // baseline top-left adjustments below
          if (placement === "center") {
            x = (W - tw) / 2;
            y = (H + th) / 2;
          } else if (placement === "top-left") {
            x = margin;
            y = margin + th;
          } else if (placement === "top-center") {
            x = (W - tw) / 2;
            y = margin + th;
          } else if (placement === "top-right") {
            x = W - margin - tw;
            y = margin + th;
          } else if (placement === "middle-left") {
            x = margin;
            y = H / 2 + th / 2;
          } else if (placement === "middle-right") {
            x = W - margin - tw;
            y = H / 2 + th / 2;
          } else if (placement === "bottom-left") {
            x = margin;
            y = H - margin;
          } else if (placement === "bottom-center") {
            x = (W - tw) / 2;
            y = H - margin;
          } else if (placement === "bottom-right") {
            x = W - margin - tw;
            y = H - margin;
          }
          pctx.save();
          pctx.translate(x + tw / 2, y - th / 2);
          pctx.rotate(-Math.PI / 4);
          pctx.fillStyle = hexToRGBA(hex, opacity);
          pctx.fillText(text, -tw / 2, th / 2);
          pctx.restore();
        }
      }

      function setPlacementUI() {
        const isCustom = placementSelect.value === "custom";
        previewHint.style.display = isCustom ? "block" : "none";
      }

      // Mouse interactions for custom placement
      function setCustomFromEvent(ev) {
        const rect = previewCanvas.getBoundingClientRect();
        const cx = Math.max(
          0,
          Math.min(previewCanvas.width, ev.clientX - rect.left)
        );
        const cy = Math.max(
          0,
          Math.min(previewCanvas.height, ev.clientY - rect.top)
        );
        const margin =
          Math.max(previewCanvas.width, previewCanvas.height) * 0.06;
        const innerW = Math.max(1, previewCanvas.width - 2 * margin);
        const innerH = Math.max(1, previewCanvas.height - 2 * margin);
        customPos.x = Math.max(0, Math.min(1, (cx - margin) / innerW));
        customPos.y = Math.max(0, Math.min(1, (cy - margin) / innerH));
        drawPreview();
      }
      previewCanvas.addEventListener("mousedown", (ev) => {
        if (placementSelect.value !== "custom") return;
        dragging = true;
        setCustomFromEvent(ev);
      });
      window.addEventListener("mousemove", (ev) => {
        if (!dragging) return;
        setCustomFromEvent(ev);
      });
      window.addEventListener("mouseup", () => {
        dragging = false;
      });

      // Redraw preview on inputs
      [wmTextInput, wmOpacityInput, wmColorInput, sizeSelect].forEach((el) =>
        el.addEventListener("input", drawPreview)
      );
      placementSelect.addEventListener("change", () => {
        setPlacementUI();
        drawPreview();
      });
      setPlacementUI();
      drawPreview();

      applyBtn.addEventListener("click", async () => {
        if (!loaded) return;
        applyBtn.disabled = true;
        statusText.textContent = "Applying watermark...";
        try {
          const outDoc = await PDFLib.PDFDocument.create();
          const pageCount = loaded.getPageCount();
          const pages = await outDoc.copyPages(
            loaded,
            Array.from({ length: pageCount }, (_, i) => i)
          );
          const wmText = (wmTextInput.value || "").trim() || "WATERMARK";
          const opacity = Math.min(
            1,
            Math.max(0.05, parseFloat(wmOpacityInput.value) || 0.2)
          );
          // Color parsing (hex -> rgb)
          function hexToRgb(hex) {
            const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(
              hex || ""
            );
            return m
              ? {
                  r: parseInt(m[1], 16),
                  g: parseInt(m[2], 16),
                  b: parseInt(m[3], 16),
                }
              : { r: 229, g: 57, b: 53 };
          }
          const rgb = hexToRgb(wmColorInput && wmColorInput.value);
          const color = PDFLib.rgb(rgb.r / 255, rgb.g / 255, rgb.b / 255);
          const helv = await outDoc.embedFont(PDFLib.StandardFonts.Helvetica);
          const placement = placementSelect.value;
          const sizeMode = sizeSelect.value;
          function sizeFactor(mode) {
            return mode === "small" ? 0.08 : mode === "large" ? 0.18 : 0.12;
          }
          pages.forEach((p) => {
            outDoc.addPage(p);
            const { width, height } = p.getSize();
            const margin = Math.max(width, height) * 0.04;
            function fontSizeForPage() {
              if (placement === "diagonal" && sizeMode === "auto") {
                const target = Math.hypot(
                  width - 2 * margin,
                  height - 2 * margin
                );
                const unit = helv.widthOfTextAtSize(wmText, 1);
                return unit > 0 ? target / unit : Math.min(width, height) / 5;
              }
              return Math.min(width, height) * sizeFactor(sizeMode);
            }
            const fontSize = fontSizeForPage();
            const textW = helv.widthOfTextAtSize(wmText, fontSize);
            const textH = helv.heightAtSize(fontSize);
            let x = margin,
              y = margin; // baseline
            if (placement === "diagonal") {
              x = margin;
              y = margin;
            } else if (placement === "custom") {
              const innerW = Math.max(1, width - 2 * margin);
              const innerH = Math.max(1, height - 2 * margin);
              x = margin + customPos.x * innerW - textW / 2;
              y = margin + customPos.y * innerH - textH / 2;
            } else {
              if (placement === "center") {
                x = (width - textW) / 2;
                y = (height - textH) / 2;
              } else if (placement === "top-left") {
                x = margin;
                y = height - margin - textH;
              } else if (placement === "top-center") {
                x = (width - textW) / 2;
                y = height - margin - textH;
              } else if (placement === "top-right") {
                x = width - margin - textW;
                y = height - margin - textH;
              } else if (placement === "middle-left") {
                x = margin;
                y = (height - textH) / 2;
              } else if (placement === "middle-right") {
                x = width - margin - textW;
                y = (height - textH) / 2;
              } else if (placement === "bottom-left") {
                x = margin;
                y = margin;
              } else if (placement === "bottom-center") {
                x = (width - textW) / 2;
                y = margin;
              } else if (placement === "bottom-right") {
                x = width - margin - textW;
                y = margin;
              }
            }
            p.drawText(wmText, {
              x,
              y,
              size: fontSize,
              font: helv,
              opacity,
              rotate: PDFLib.degrees(45),
              color,
            });
          });
          const bytes = await outDoc.save();
          outBlob = new Blob([bytes], { type: "application/pdf" });
          downloadBtn.style.display = "inline-block";
          statusText.textContent =
            "Watermark applied diagonally (bottom-left to top-right).";
        } catch (e) {
          console.error(e);
          statusText.textContent = "Failed.";
        } finally {
          applyBtn.disabled = false;
        }
      });

      downloadBtn.addEventListener("click", () => {
        if (!outBlob) return;
        const url = URL.createObjectURL(outBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = getOutputName("watermarked");
        a.click();
        URL.revokeObjectURL(url);
      });

      // "Try it now" link functionality
      document.addEventListener("DOMContentLoaded", function () {
        const tryLinks = document.querySelectorAll('a[href="#file-input"]');
        tryLinks.forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const fileInput = document.getElementById("file-input");
            if (fileInput) {
              fileInput.click();
              setTimeout(() => {
                window.scrollTo({ top: 0, behavior: "smooth" });
              }, 100);
            }
          });
        });
      });
    </script>
    <script src="../assets/app.js"></script>
  </body>
</html>
